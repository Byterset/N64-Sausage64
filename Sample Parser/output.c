/***************************************************************
                           texture.c
                             
Outputs the parsed data to a file
***************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include "main.h"
#include "texture.h"
#include "mesh.h"
#include "animation.h"

#define RADIAN 57.2957795

/*==============================
    write_output_text
    Writes the output to a text file
==============================*/

void write_output_text()
{
    FILE* fp;
    listNode* curnode;
    
    // Open the file
    fp = fopen(global_outputname, "w+");
    if (fp == NULL)
        terminate("Error: Unable to open file for writing\n");
        
    // Print the header
    fprintf(fp, "// Generated by SausN64\n");
    fprintf(fp, "// By Buu342\n");
    
    // Iterate through all the meshes and print their names
    curnode = list_meshes.head;
    fprintf(fp, "// Mesh count: %d\n", list_meshes.size);
    while (curnode != NULL)
    {
        s64Mesh* mesh = (s64Mesh*)curnode->data;
        fprintf(fp, "// * gfx_%s_%s | MESH_%s_%s\n", global_modelname, mesh->name, global_modelname, mesh->name);
        curnode = curnode->next;
    }
    
    // Iterate through all the animations and print their names
    curnode = list_animations.head;
    fprintf(fp, "// Animation count: %d\n", list_animations.size);
    while (curnode != NULL)
    {
        s64Anim* anim = (s64Anim*)curnode->data;
        fprintf(fp, "// * anim_%s_%s | ANIMATION_%s_%s\n", global_modelname, anim->name, global_modelname, anim->name);
        curnode = curnode->next;
    }
    fputs("\n", fp);
    
    // Iterate through the output list and write the model data
    curnode = list_output.head;
    while (curnode != NULL)
    {
        char* str = (char*)curnode->data;
        fputs(str, fp);
        curnode = curnode->next;
    }
    
    // Write the animation data
    fputs("\n", fp);
    fputs("/*********************************\n"
          "          Animation Data\n"
          "*********************************/", fp);
    curnode = list_animations.head;
    while (curnode != NULL)
    {
        s64Anim* anim = (s64Anim*)curnode->data;
        listNode* keyfnode = anim->keyframes.head;
        fputs("\n\n", fp);
        
        // Print an array of framedata
        while (keyfnode != NULL)
        {
            s64Keyframe* keyf = (s64Keyframe*)keyfnode->data;
            listNode* fdatanode = keyf->framedata.head;
            fprintf(fp, "FrameData anim_%s_%s_framedata%d[] = {\n", global_modelname, anim->name, keyf->keyframe);
            while (fdatanode != NULL)
            {
                s64FrameData* fdata = (s64FrameData*)fdatanode->data;
                fprintf(fp, "    {%.4f, %.4f, %.4f, %.4f, %.4f, %.4f, %.4f, %.4f, %.4f},\n", 
                    fdata->translation.x, fdata->translation.y, fdata->translation.z,
                    fdata->rotation.x*RADIAN, fdata->rotation.y*RADIAN, fdata->rotation.z*RADIAN,
                    fdata->scale.x, fdata->scale.y, fdata->scale.z
                );
                fdatanode = fdatanode->next;
            }
            fprintf(fp, "};\n");
            keyfnode = keyfnode->next;
        }
        
        // Then print an array of keyframes
        keyfnode = anim->keyframes.head;
        fprintf(fp, "KeyFrame anim_%s_%s_keyframes[] = {\n", global_modelname, anim->name);
        while (keyfnode != NULL)
        {
            s64Keyframe* keyf = (s64Keyframe*)keyfnode->data;
            fprintf(fp, "    {%d, %d, anim_%s_%s_framedata%d},\n", keyf->keyframe, list_meshes.size, global_modelname, anim->name, keyf->keyframe);
            keyfnode = keyfnode->next;
        }
        fprintf(fp, "};\n", global_modelname, anim->name);
        
        // Finally, print the animation
        fprintf(fp, "Animation anim_%s_%s[] = {\"%s\", %d, anim_%s_%s_keyframes};", global_modelname, anim->name, anim->name, anim->keyframes.size, global_modelname, anim->name);
        curnode = curnode->next;
    }
        
    // Finish
    if (!global_quiet) printf("*Wrote output to '%s'", global_outputname);
    fclose(fp);
}


/*==============================
    write_output_binary
    NOT IMPLEMENTED!
    Writes the output to a binary file.
==============================*/

void write_output_binary()
{
    FILE* fp;
    listNode* curnode = list_output.head;
    
    // Open the file
    fp = fopen(global_outputname, "wb+");
    if (fp == NULL)
        terminate("Error: Unable to open file for writing\n");
    
    // TODO
        
    if (!global_quiet) printf("*Wrote output to '%s'", global_outputname);
    fclose(fp);
}